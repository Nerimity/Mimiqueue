{"version":3,"sources":["../src/Queue.ts","../src/AltQueue.ts","../src/AltQueue2.ts","../src/Timeout.ts"],"sourcesContent":["import { createClient } from \"redis\";\r\nimport { Queue as MemoryQueue } from \"async-await-queue\";\r\n\r\ntype RedisClient = ReturnType<typeof createClient>;\r\n\r\ninterface QueueOpts<T> {\r\n  name: string;\r\n  redisClient: RedisClient;\r\n  process: T;\r\n}\r\nexport class Queue<\r\n  T extends (data: any) => Promise<any> = (data: any) => Promise<any>\r\n> {\r\n  addQueue = new MemoryQueue(1);\r\n\r\n  redisClient: RedisClient;\r\n  name: string;\r\n  prefix = \"mimiqueue\";\r\n  ids: Map<string, [any, any]> = new Map();\r\n  sub: RedisClient;\r\n  processFn: T;\r\n  constructor(opts: QueueOpts<T>) {\r\n    this.processFn = opts.process;\r\n    this.name = opts.name;\r\n    this.redisClient = opts.redisClient;\r\n    this.sub = this.redisClient.duplicate();\r\n    this.sub.connect();\r\n\r\n    this.sub.subscribe(\"mimiqueue\", async (message) => {\r\n      const payload = JSON.parse(message) as [\r\n        \"start\" | \"finish\",\r\n        string,\r\n        string,\r\n        string\r\n      ]; // [action, name, id, groupName?]\r\n\r\n      if (payload[0] === \"start\") {\r\n        this.startJob(payload[1], payload[2], payload[3]);\r\n      }\r\n\r\n      if (payload[0] === \"finish\") {\r\n        if (this.name !== payload[1]) return;\r\n        if (!this.ids.delete(payload[2])) return;\r\n\r\n        const latestJob = await getAndMoveLatestWaitingJobToActive(\r\n          this,\r\n          payload[3]\r\n        );\r\n        if (!latestJob) return;\r\n        const newPayload = JSON.stringify([\r\n          \"start\",\r\n          this.name,\r\n          latestJob.id,\r\n          payload[3],\r\n        ]);\r\n        this.redisClient.publish(\"mimiqueue\", newPayload);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async startJob(name: string, id: string, groupName?: string) {\r\n    if (name !== this.name) return;\r\n    const cb = this.ids.get(id);\r\n    if (!cb) return;\r\n\r\n    const job = await getJobById(this, id, groupName);\r\n    const data = JSON.parse(job.data || \"null\");\r\n    await this.processFn(data)\r\n      .then((result: any) => {\r\n        return cb[0](result);\r\n      })\r\n      .catch((e: any) => {\r\n        return cb[1](e);\r\n      });\r\n\r\n    await removeActiveJob(this, id, groupName);\r\n    this.redisClient.publish(\r\n      \"mimiqueue\",\r\n      JSON.stringify([\"finish\", name, id, groupName])\r\n    );\r\n  }\r\n  async add(data: any, opts?: { groupName?: string }) {\r\n    const id = await this.addQueue.run(async () => {\r\n      const id = await addJob(this, data, opts?.groupName);\r\n\r\n      const hasActiveOrWaitingJobs = await activeOrWaitingJobCount(\r\n        this,\r\n        opts?.groupName\r\n      );\r\n      if (hasActiveOrWaitingJobs) {\r\n        await addJobToWaiting(this, id, opts?.groupName);\r\n      }\r\n\r\n      if (!hasActiveOrWaitingJobs) {\r\n        await addJobToActive(this, id, opts?.groupName);\r\n        const payload = JSON.stringify([\r\n          \"start\",\r\n          this.name,\r\n          id.toString(),\r\n          opts?.groupName,\r\n        ]);\r\n        this.redisClient.publish(\"mimiqueue\", payload);\r\n      }\r\n      return id;\r\n    });\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.ids.set(id.toString(), [resolve, reject]);\r\n    });\r\n  }\r\n}\r\n\r\nasync function genId(queue: Queue) {\r\n  return await queue.redisClient.incr(`${queue.prefix}:${queue.name}:id`);\r\n}\r\n\r\nasync function addJob<T>(queue: Queue, data: T, groupName?: string) {\r\n  const id = await genId(queue);\r\n\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += `:${id}`;\r\n\r\n  await queue.redisClient.hSet(key, {\r\n    data: JSON.stringify(data),\r\n    createdAt: Date.now(),\r\n  });\r\n\r\n  return id;\r\n}\r\n\r\nfunction addJobToWaiting(queue: Queue, id: number, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":wait\";\r\n\r\n  return queue.redisClient.rPush(key, id.toString());\r\n}\r\n\r\nfunction addJobToActive(queue: Queue, id: number | string, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":active\";\r\n\r\n  return queue.redisClient.set(key, id.toString());\r\n}\r\n\r\nasync function activeOrWaitingJobCount(queue: Queue, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n\r\n  const multi = queue.redisClient.multi();\r\n  multi.get(`${key}:active`);\r\n  multi.lLen(`${key}:wait`);\r\n\r\n  const [active, wait] = (await multi.exec()) as [number, number];\r\n\r\n  return (active ? 1 : 0) + wait;\r\n}\r\n\r\nasync function getJobById(queue: Queue, id: string, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n\r\n  return queue.redisClient.hGetAll(`${key}:${id.toString()}`);\r\n}\r\nasync function removeActiveJob(queue: Queue, id: string, groupName?: string) {\r\n  let key1 = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key1 += `:${groupName}`;\r\n  key1 += \":active\";\r\n\r\n  let key2 = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key2 += `:${groupName}`;\r\n  key2 += `:${id}`;\r\n  const multi = queue.redisClient.multi();\r\n\r\n  multi.del(key1);\r\n  multi.del(key2);\r\n\r\n  return multi.exec();\r\n}\r\n\r\nasync function removeWaitingJob(queue: Queue, id: string, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":wait\";\r\n  return queue.redisClient.lRem(key, 1, id.toString());\r\n}\r\n\r\nasync function getAndMoveLatestWaitingJobToActive(\r\n  queue: Queue,\r\n  groupName?: string\r\n) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":wait\";\r\n  const id = await queue.redisClient.lIndex(key, 0);\r\n  if (!id) return null;\r\n  const activeJob = getJobById(queue, id, groupName);\r\n  if (!activeJob) return null;\r\n\r\n  await removeWaitingJob(queue, id, groupName);\r\n  await addJobToActive(queue, id, groupName);\r\n  return { job: activeJob, id };\r\n}\r\n","import { createClient } from \"redis\";\r\nimport { Queue as MemoryQueue } from \"async-await-queue\";\r\n\r\ntype RedisClient = ReturnType<typeof createClient>;\r\n\r\nexport interface AltQueueOpts {\r\n  name: string;\r\n  redisClient: RedisClient;\r\n}\r\nexport class AltQueue {\r\n  addQueue = new MemoryQueue(1);\r\n\r\n  redisClient: RedisClient;\r\n  name: string;\r\n  prefix = \"mimiqueue\";\r\n  ids: Map<string, () => void> = new Map();\r\n  sub: RedisClient;\r\n  constructor(opts: AltQueueOpts) {\r\n    this.name = opts.name;\r\n    this.redisClient = opts.redisClient;\r\n    this.sub = this.redisClient.duplicate();\r\n    this.sub.connect();\r\n\r\n    this.sub.subscribe(\"mimiqueue\", async (message) => {\r\n      const payload = JSON.parse(message) as [\r\n        \"start\" | \"finish\",\r\n        string,\r\n        string,\r\n        string\r\n      ]; // [action, name, id, groupName?]\r\n\r\n      if (payload[0] === \"start\") {\r\n        this.startJob(payload[1], payload[2], payload[3]);\r\n      }\r\n\r\n      if (payload[0] === \"finish\") {\r\n        if (this.name !== payload[1]) return;\r\n        if (!this.ids.delete(payload[2])) return;\r\n\r\n        const latestJob = await getAndMoveLatestWaitingJobToActive(\r\n          this,\r\n          payload[3]\r\n        );\r\n        if (!latestJob) return;\r\n        const newPayload = JSON.stringify([\r\n          \"start\",\r\n          this.name,\r\n          latestJob.id,\r\n          payload[3],\r\n        ]);\r\n        this.redisClient.publish(\"mimiqueue\", newPayload);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async startJob(name: string, id: string, groupName?: string) {\r\n    if (name !== this.name) return;\r\n    const cb = this.ids.get(id);\r\n    if (!cb) return;\r\n\r\n    cb();\r\n\r\n    // await removeActiveJob(this, id, groupName);\r\n    // this.redisClient.publish(\r\n    //   \"mimiqueue\",\r\n    //   JSON.stringify([\"finish\", name, id, groupName])\r\n    // );\r\n  }\r\n\r\n  async start(opts?: { groupName?: string }): Promise<() => Promise<void>> {\r\n    const id = await this.addQueue.run(async () => {\r\n      const id = await addJob(this, opts?.groupName);\r\n\r\n      const hasActiveOrWaitingJobs = await activeOrWaitingJobCount(\r\n        this,\r\n        opts?.groupName\r\n      );\r\n      if (hasActiveOrWaitingJobs) {\r\n        await addJobToWaiting(this, id, opts?.groupName);\r\n      }\r\n\r\n      if (!hasActiveOrWaitingJobs) {\r\n        await addJobToActive(this, id, opts?.groupName);\r\n        const payload = JSON.stringify([\r\n          \"start\",\r\n          this.name,\r\n          id.toString(),\r\n          opts?.groupName,\r\n        ]);\r\n        this.redisClient.publish(\"mimiqueue\", payload);\r\n      }\r\n      return id;\r\n    });\r\n\r\n    return new Promise((res) => {\r\n      this.ids.set(id.toString(), () =>\r\n        res(async () => {\r\n          const cb = this.ids.get(id.toString());\r\n          if (!cb) return;\r\n\r\n          const idStr = id.toString();\r\n          await removeActiveJob(this, idStr, opts?.groupName);\r\n          this.redisClient.publish(\r\n            \"mimiqueue\",\r\n            JSON.stringify([\"finish\", this.name, idStr, opts?.groupName])\r\n          );\r\n        })\r\n      );\r\n    });\r\n  }\r\n}\r\n\r\nasync function genId(queue: AltQueue) {\r\n  return await queue.redisClient.incr(`${queue.prefix}:${queue.name}:id`);\r\n}\r\n\r\nasync function addJob(queue: AltQueue, groupName?: string) {\r\n  const id = await genId(queue);\r\n\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += `:${id}`;\r\n\r\n  await queue.redisClient.hSet(key, {\r\n    createdAt: Date.now(),\r\n  });\r\n\r\n  return id;\r\n}\r\n\r\nfunction addJobToWaiting(queue: AltQueue, id: number, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":wait\";\r\n\r\n  return queue.redisClient.rPush(key, id.toString());\r\n}\r\n\r\nfunction addJobToActive(\r\n  queue: AltQueue,\r\n  id: number | string,\r\n  groupName?: string\r\n) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":active\";\r\n\r\n  return queue.redisClient.set(key, id.toString());\r\n}\r\n\r\nasync function activeOrWaitingJobCount(queue: AltQueue, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n\r\n  const multi = queue.redisClient.multi();\r\n  multi.get(`${key}:active`);\r\n  multi.lLen(`${key}:wait`);\r\n\r\n  const [active, wait] = (await multi.exec()) as [number, number];\r\n\r\n  return (active ? 1 : 0) + wait;\r\n}\r\n\r\nasync function getJobById(queue: AltQueue, id: string, groupName?: string) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n\r\n  return queue.redisClient.hGetAll(`${key}:${id.toString()}`);\r\n}\r\nasync function removeActiveJob(\r\n  queue: AltQueue,\r\n  id: string,\r\n  groupName?: string\r\n) {\r\n  let key1 = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key1 += `:${groupName}`;\r\n  key1 += \":active\";\r\n\r\n  let key2 = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key2 += `:${groupName}`;\r\n  key2 += `:${id}`;\r\n  const multi = queue.redisClient.multi();\r\n\r\n  multi.del(key1);\r\n  multi.del(key2);\r\n\r\n  return multi.exec();\r\n}\r\n\r\nasync function removeWaitingJob(\r\n  queue: AltQueue,\r\n  id: string,\r\n  groupName?: string\r\n) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":wait\";\r\n  return queue.redisClient.lRem(key, 1, id.toString());\r\n}\r\n\r\nasync function getAndMoveLatestWaitingJobToActive(\r\n  queue: AltQueue,\r\n  groupName?: string\r\n) {\r\n  let key = `${queue.prefix}:${queue.name}`;\r\n  if (groupName) key += `:${groupName}`;\r\n  key += \":wait\";\r\n  const id = await queue.redisClient.lIndex(key, 0);\r\n  if (!id) return null;\r\n  const activeJob = getJobById(queue, id, groupName);\r\n  if (!activeJob) return null;\r\n\r\n  await removeWaitingJob(queue, id, groupName);\r\n  await addJobToActive(queue, id, groupName);\r\n  return { job: activeJob, id };\r\n}\r\n","import { AltQueue, AltQueueOpts } from \"./AltQueue\";\r\n\r\nexport class AltQueue2 {\r\n  private _altQueue: AltQueue;\r\n  constructor(opts: AltQueueOpts) {\r\n    this._altQueue = new AltQueue(opts);\r\n  }\r\n  async add(cb: () => Promise<void>, opts: { groupName?: string }) {\r\n    const finish = await this._altQueue.start(opts);\r\n\r\n    cb()\r\n      .catch((e) => {\r\n        console.error(e);\r\n      })\r\n      .finally(() => {\r\n        finish();\r\n      });\r\n  }\r\n}\r\n","import { createClient } from \"redis\";\r\n\r\ntype RedisClient = ReturnType<typeof createClient>;\r\n\r\ninterface HandleTimeoutOpts {\r\n  redisClient: RedisClient;\r\n  /*\r\n   * @default 30000\r\n   */\r\n  duration?: number;\r\n}\r\n\r\nconst queuedJobs = new Map<string, NodeJS.Timeout>();\r\n\r\nexport async function handleTimeout(opts: HandleTimeoutOpts) {\r\n  const redisClient = opts.redisClient;\r\n  const sub = redisClient.duplicate();\r\n  await sub.connect();\r\n\r\n  sub.subscribe(\"mimiqueue\", async (message) => {\r\n    const payload = JSON.parse(message) as [\r\n      \"start\" | \"finish\",\r\n      string,\r\n      string,\r\n      string\r\n    ]; // [action, name, id, groupName?]\r\n\r\n    if (payload[0] === \"start\") {\r\n      const name = payload[1];\r\n      const id = payload[2];\r\n\r\n      queuedJobs.set(\r\n        `${name}${id}`,\r\n        setTimeout(() => {\r\n          const newPayload = [\"finish\", payload[1], payload[2], payload[3]];\r\n          redisClient.publish(\"mimiqueue\", JSON.stringify(newPayload));\r\n        }, opts.duration || 30000)\r\n      );\r\n    }\r\n\r\n    if (payload[0] === \"finish\") {\r\n      const name = payload[1];\r\n      const id = payload[2];\r\n      queuedJobs.delete(`${name}${id}`);\r\n    }\r\n  });\r\n}\r\n"],"mappings":"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","names":["MemoryQueue","Queue","opts","message","payload","latestJob","getAndMoveLatestWaitingJobToActive","newPayload","name","id","groupName","cb","job","getJobById","data","result","e","removeActiveJob","addJob","hasActiveOrWaitingJobs","activeOrWaitingJobCount","addJobToWaiting","addJobToActive","resolve","reject","genId","queue","key","multi","active","wait","key1","key2","removeWaitingJob","activeJob","MemoryQueue","AltQueue","opts","message","payload","latestJob","getAndMoveLatestWaitingJobToActive","newPayload","name","id","groupName","cb","addJob","hasActiveOrWaitingJobs","activeOrWaitingJobCount","addJobToWaiting","addJobToActive","res","idStr","removeActiveJob","genId","queue","key","multi","active","wait","getJobById","key1","key2","removeWaitingJob","activeJob","AltQueue2","opts","AltQueue","cb","finish","e","queuedJobs","handleTimeout","opts","redisClient","sub","message","payload","name","id","newPayload"]}
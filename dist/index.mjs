import{Queue as $}from"async-await-queue";var f=class{addQueue=new $(1);redisClient;name;prefix="mimiqueue";ids=new Map;sub;processFn;constructor(n){this.processFn=n.process,this.name=n.name,this.redisClient=n.redisClient,this.sub=this.redisClient.duplicate(),this.sub.connect(),this.sub.subscribe("mimiqueue",async e=>{let t=JSON.parse(e);if(t[0]==="start"&&this.startJob(t[1],t[2],t[3]),t[0]==="remove"){if(this.name!==t[1])return;this.ids.delete(t[2])}if(t[0]==="finish"){if(this.name!==t[1]||!this.ids.delete(t[2]))return;let s=await x(this,t[3]);if(!s)return;let r=JSON.stringify(["start",this.name,s.id,t[3]]);this.redisClient.publish("mimiqueue",r)}})}async startJob(n,e,t){if(n!==this.name)return;let s=this.ids.get(e);if(!s)return;let r=await m(this,e,t),a=JSON.parse(r.data||"null");await this.processFn(a).then(o=>s[0](o)).catch(o=>s[1](o)),await J(this,e,t),this.redisClient.publish("mimiqueue",JSON.stringify(["finish",n,e,t]))}async add(n,e){let t=await this.addQueue.run(async()=>{let s=await w(this,n,e?.groupName),r=await p(this,e?.groupName);if(r&&await C(this,s,e?.groupName),!r){await u(this,s,e?.groupName);let a=JSON.stringify(["start",this.name,s.toString(),e?.groupName]);this.redisClient.publish("mimiqueue",a)}return s});return new Promise((s,r)=>{this.ids.set(t.toString(),[s,r])})}};async function b(i){return await i.redisClient.incr(`${i.prefix}:${i.name}:id`)}async function w(i,n,e){let t=await b(i),s=`${i.prefix}:${i.name}`;return e&&(s+=`:${e}`),s+=`:${t}`,await i.redisClient.hSet(s,{data:JSON.stringify(n),createdAt:Date.now()}),t}function C(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),t+=":wait",i.redisClient.rPush(t,n.toString())}function u(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),t+=":active",i.redisClient.set(t,n.toString())}async function p(i,n){let e=`${i.prefix}:${i.name}`;n&&(e+=`:${n}`);let t=i.redisClient.multi();t.get(`${e}:active`),t.lLen(`${e}:wait`);let[s,r]=await t.exec();return(s?1:0)+r}async function m(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),i.redisClient.hGetAll(`${t}:${n.toString()}`)}async function J(i,n,e){let t=`${i.prefix}:${i.name}`;e&&(t+=`:${e}`),t+=":active";let s=`${i.prefix}:${i.name}`;e&&(s+=`:${e}`),s+=`:${n}`;let r=i.redisClient.multi();return r.del(t),r.del(s),r.exec()}async function v(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),t+=":wait",i.redisClient.lRem(t,1,n.toString())}async function x(i,n){let e=`${i.prefix}:${i.name}`;n&&(e+=`:${n}`),e+=":wait";let t=await i.redisClient.lIndex(e,0);if(!t)return null;let s=m(i,t,n);return s?(await v(i,t,n),await u(i,t,n),{job:s,id:t}):null}import{Queue as Q}from"async-await-queue";var c=class{addQueue=new Q(1);redisClient;name;prefix="mimiqueue";ids=new Map;sub;constructor(n){this.name=n.name,this.redisClient=n.redisClient,this.sub=this.redisClient.duplicate(),this.sub.connect(),this.sub.subscribe("mimiqueue",async e=>{let t=JSON.parse(e);if(t[0]==="remove"){if(this.name!==t[1])return;this.ids.delete(t[2])}if(t[0]==="start"&&this.startJob(t[1],t[2],t[3]),t[0]==="finish"){if(this.name!==t[1]||!this.ids.delete(t[2]))return;let s=await W(this,t[3]);if(!s)return;let r=JSON.stringify(["start",this.name,s.id,t[3]]);this.redisClient.publish("mimiqueue",r)}})}async startJob(n,e,t){if(n!==this.name)return;let s=this.ids.get(e);s&&s()}async start(n){let e=await this.addQueue.run(async()=>{let t=await A(this,n?.groupName),s=await T(this,n?.groupName);if(s&&await O(this,t,n?.groupName),!s){await g(this,t,n?.groupName);let r=JSON.stringify(["start",this.name,t.toString(),n?.groupName]);this.redisClient.publish("mimiqueue",r)}return t});return new Promise(t=>{this.ids.set(e.toString(),()=>t(async()=>{if(!this.ids.get(e.toString()))return;let r=e.toString();await R(this,r,n?.groupName),this.redisClient.publish("mimiqueue",JSON.stringify(["finish",this.name,r,n?.groupName]))}))})}};async function S(i){return await i.redisClient.incr(`${i.prefix}:${i.name}:id`)}async function A(i,n){let e=await S(i),t=`${i.prefix}:${i.name}`;return n&&(t+=`:${n}`),t+=`:${e}`,await i.redisClient.hSet(t,{createdAt:Date.now()}),e}function O(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),t+=":wait",i.redisClient.rPush(t,n.toString())}function g(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),t+=":active",i.redisClient.set(t,n.toString())}async function T(i,n){let e=`${i.prefix}:${i.name}`;n&&(e+=`:${n}`);let t=i.redisClient.multi();t.get(`${e}:active`),t.lLen(`${e}:wait`);let[s,r]=await t.exec();return(s?1:0)+r}async function k(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),i.redisClient.hGetAll(`${t}:${n.toString()}`)}async function R(i,n,e){let t=`${i.prefix}:${i.name}`;e&&(t+=`:${e}`),t+=":active";let s=`${i.prefix}:${i.name}`;e&&(s+=`:${e}`),s+=`:${n}`;let r=i.redisClient.multi();return r.del(t),r.del(s),r.exec()}async function P(i,n,e){let t=`${i.prefix}:${i.name}`;return e&&(t+=`:${e}`),t+=":wait",i.redisClient.lRem(t,1,n.toString())}async function W(i,n){let e=`${i.prefix}:${i.name}`;n&&(e+=`:${n}`),e+=":wait";let t=await i.redisClient.lIndex(e,0);if(!t)return null;let s=k(i,t,n);return s?(await P(i,t,n),await g(i,t,n),{job:s,id:t}):null}var y=class{_altQueue;constructor(n){this._altQueue=new c(n)}async add(n,e){let t=await this._altQueue.start(e);n().catch(s=>{console.error(s)}).finally(()=>{t()})}};var l=new Map;async function K(i){let n=i.redisClient,e=n.duplicate();await e.connect(),e.subscribe("mimiqueue",async t=>{let s=JSON.parse(t);if(s[0]==="start"){let r=s[1],a=s[2];l.set(`${r}${a}`,setTimeout(async()=>{let o=JSON.stringify(["remove",s[1],s[2],s[3]]);n.publish("mimiqueue",o),await B(n,r,a,s[3]);let d=await I(n,s[1],s[3]);if(!d)return;let h=JSON.stringify(["start",s[1],d.id,s[3]]);n.publish("mimiqueue",h)},i.duration||3e4))}if(s[0]==="finish"){let r=s[1],a=s[2],o=l.get(`${r}${a}`);clearTimeout(o),l.delete(`${r}${a}`)}})}async function M(i,n,e,t){let s=`mimiqueue:${n}`;return t&&(s+=`:${t}`),s+=":wait",i.lRem(s,1,e.toString())}async function I(i,n,e){let t=`mimiqueue:${n}`;e&&(t+=`:${e}`),t+=":wait";let s=await i.lIndex(t,0);if(!s)return null;let r=L(i,n,s,e);return r?(await M(i,n,s,e),await j(i,n,s,e),{job:r,id:s}):null}async function L(i,n,e,t){let s=`mimiqueue:${n}`;return t&&(s+=`:${t}`),i.hGetAll(`${s}:${e.toString()}`)}function j(i,n,e,t){let s=`mimiqueue:${n}`;return t&&(s+=`:${t}`),s+=":active",i.set(s,e.toString())}function B(i,n,e,t){let s=`mimiqueue:${n}`;return t&&(s+=`:${t}`),s+=":active",i.del(s)}export{c as AltQueue,y as AltQueue2,f as Queue,K as handleTimeout};
//# sourceMappingURL=index.mjs.map